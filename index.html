<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.5">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #6d6d6d; -webkit-text-stroke: #6d6d6d}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #0000ff; -webkit-text-stroke: #0000ff}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #6b0001; -webkit-text-stroke: #6b0001}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #fb0007; -webkit-text-stroke: #fb0007}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; -webkit-text-stroke: #000000}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #4d5055; -webkit-text-stroke: #4d5055}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #093c94; -webkit-text-stroke: #093c94}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #6f0ec3; -webkit-text-stroke: #6f0ec3}
    p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; -webkit-text-stroke: #000000; min-height: 16.0px}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #18702b; -webkit-text-stroke: #18702b}
    p.p11 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #0e6e6d; -webkit-text-stroke: #0e6e6d}
    span.s1 {font-kerning: none; background-color: #ecf1f7}
    span.s2 {font-kerning: none; color: #fb0007; background-color: #ecf1f7; -webkit-text-stroke: 0px #fb0007}
    span.s3 {font-kerning: none; color: #2a2a2a; background-color: #ecf1f7; -webkit-text-stroke: 0px #2a2a2a}
    span.s4 {font-kerning: none; color: #6b0001; background-color: #ecf1f7; -webkit-text-stroke: 0px #6b0001}
    span.s5 {font-kerning: none; color: #000000; background-color: #ecf1f7; -webkit-text-stroke: 0px #000000}
    span.s6 {font-kerning: none; color: #0000ff; background-color: #ecf1f7; -webkit-text-stroke: 0px #0000ff}
    span.s7 {font-kerning: none; color: #18702b; background-color: #ecf1f7; -webkit-text-stroke: 0px #18702b}
    span.s8 {font-kerning: none; color: #093c94; background-color: #ecf1f7; -webkit-text-stroke: 0px #093c94}
    span.s9 {font-kerning: none; color: #137646; background-color: #ecf1f7; -webkit-text-stroke: 0px #137646}
    span.s10 {font-kerning: none; color: #6f0ec3; background-color: #ecf1f7; -webkit-text-stroke: 0px #6f0ec3}
    span.s11 {font-kerning: none}
    span.s12 {font-kerning: none; color: #0e6e6d; background-color: #ecf1f7; -webkit-text-stroke: 0px #0e6e6d}
    span.s13 {font-kerning: none; color: #a4450b; background-color: #ecf1f7; -webkit-text-stroke: 0px #a4450b}
    span.s14 {font-kerning: none; color: #4d5055; background-color: #ecf1f7; -webkit-text-stroke: 0px #4d5055}
  </style>
</head>
<body>
<p class="p1"><span class="s1">&lt;!DOCTYPE</span><span class="s2"> html</span><span class="s1">&gt;</span></p>
<p class="p2"><span class="s3">&lt;</span><span class="s4">html</span><span class="s5"> </span><span class="s2">lang</span><span class="s3">=</span><span class="s1">"zh-TW"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s3">&lt;</span><span class="s1">head</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">meta</span><span class="s5"> </span><span class="s1">charset</span><span class="s3">=</span><span class="s6">"UTF-8"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">meta</span><span class="s5"> </span><span class="s2">name</span><span class="s3">=</span><span class="s1">"viewport"</span><span class="s5"> </span><span class="s2">content</span><span class="s3">=</span><span class="s1">"width=device-width, initial-scale=1.0"</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">title</span><span class="s3">&gt;</span><span class="s1">教師教學輔助工具</span><span class="s3">&lt;/</span><span class="s4">title</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">&lt;!-- Tailwind CSS CDN --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">script</span><span class="s5"> </span><span class="s2">src</span><span class="s3">=</span><span class="s1">"https://cdn.tailwindcss.com"</span><span class="s3">&gt;&lt;/</span><span class="s4">script</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">&lt;!-- Inter Font --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">link</span><span class="s5"> </span><span class="s2">rel</span><span class="s3">=</span><span class="s1">"stylesheet"</span><span class="s5"> </span><span class="s2">href</span><span class="s3">=</span><span class="s1">"https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&amp;display=swap"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s1">style</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">body</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s2">font-family:</span><span class="s1"> </span><span class="s7">'Inter'</span><span class="s1">, </span><span class="s8">sans-serif</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.perspective-1000</span><span class="s5"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s2">perspective:</span><span class="s1"> </span><span class="s9">1000px</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.transform-style-preserve-3d</span><span class="s5"> {</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">transform-style:</span><span class="s5"> </span><span class="s8">preserve-3d</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.backface-hidden</span><span class="s5"> {</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">backface-visibility:</span><span class="s5"> </span><span class="s8">hidden</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.rotate-y-180</span><span class="s5"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s2">transform:</span><span class="s1"> </span><span class="s8">rotateY(</span><span class="s9">180deg</span><span class="s8">)</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.custom-loader</span><span class="s5"> {</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">border-top-color:</span><span class="s5"> </span><span class="s8">#3b82f6</span><span class="s5">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s2">-webkit-animation:</span><span class="s5"> </span><span class="s1">spinner</span><span class="s5"> </span><span class="s9">1s</span><span class="s5"> </span><span class="s1">linear</span><span class="s5"> </span><span class="s1">infinite</span><span class="s5">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s2">animation:</span><span class="s5"> </span><span class="s1">spinner</span><span class="s5"> </span><span class="s9">1s</span><span class="s5"> </span><span class="s1">linear</span><span class="s5"> </span><span class="s1">infinite</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">@-webkit-keyframes</span><span class="s5"> </span><span class="s8">spinner</span><span class="s5"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s9">0%</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s2">-webkit-transform:</span><span class="s1"> </span><span class="s8">rotate(</span><span class="s9">0deg</span><span class="s8">)</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s9">100%</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s2">-webkit-transform:</span><span class="s1"> </span><span class="s8">rotate(</span><span class="s9">360deg</span><span class="s8">)</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">@keyframes</span><span class="s1"> </span><span class="s8">spinner</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s9">0%</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s2">transform:</span><span class="s1"> </span><span class="s8">rotate(</span><span class="s9">0deg</span><span class="s8">)</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s9">100%</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s2">transform:</span><span class="s1"> </span><span class="s8">rotate(</span><span class="s9">360deg</span><span class="s8">)</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s1">style</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s3">&lt;/</span><span class="s1">head</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;</span><span class="s4">body</span><span class="s5"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"bg-gray-100"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"app-root"</span><span class="s5"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"min-h-screen p-4 sm:p-6 lg:p-8 font-sans"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">&lt;!-- Application content will be rendered here --&gt;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">&lt;!-- Firebase SDKs --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">script</span><span class="s5"> </span><span class="s2">type</span><span class="s3">=</span><span class="s1">"module"</span><span class="s3">&gt;</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s10">import</span><span class="s5"> { initializeApp } </span><span class="s10">from</span><span class="s5"> </span><span class="s1">"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">import</span><span class="s1"> { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } </span><span class="s10">from</span><span class="s1"> </span><span class="s7">"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">import</span><span class="s1"> { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } </span><span class="s10">from</span><span class="s1"> </span><span class="s7">"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"</span><span class="s1">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// Expose Firebase modules to the global scope for the main script</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>window.</span><span class="s12">Firebase</span><span class="s1"> = {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>initializeApp,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s1">script</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">    </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">&lt;!-- QRCode.js CDN --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">script</span><span class="s5"> </span><span class="s2">src</span><span class="s3">=</span><span class="s1">"https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"</span><span class="s3">&gt;&lt;/</span><span class="s4">script</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">script</span><span class="s5"> </span><span class="s2">type</span><span class="s3">=</span><span class="s1">"text/javascript"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// Global variables provided by the Canvas environment or with fallbacks</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> appId = </span><span class="s10">typeof</span><span class="s1"> __app_id !== </span><span class="s7">'undefined'</span><span class="s1"> ? __app_id : </span><span class="s7">'default-app-id'</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> firebaseConfig = </span><span class="s10">typeof</span><span class="s1"> __firebase_config !== </span><span class="s7">'undefined'</span><span class="s1"> ? </span><span class="s12">JSON</span><span class="s1">.parse(__firebase_config) : {};</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> initialAuthToken = </span><span class="s10">typeof</span><span class="s1"> __initial_auth_token !== </span><span class="s7">'undefined'</span><span class="s1"> ? __initial_auth_token : </span><span class="s10">null</span><span class="s1">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// Helper function to generate a unique ID</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> generateUniqueId = () =&gt; </span><span class="s7">'id-'</span><span class="s1"> + </span><span class="s12">Math</span><span class="s1">.random().toString(</span><span class="s13">36</span><span class="s1">).substr(</span><span class="s13">2</span><span class="s1">, </span><span class="s13">9</span><span class="s1">);</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// Helper function to show a custom modal message</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> showMessage = (message) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> modalHtml = </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="text-lg font-semibold text-gray-800 mb-4"&gt;</span><span class="s5">${message}</span><span class="s1">&lt;/p&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;button onclick="document.querySelector('.fixed.inset-0').remove()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300"&gt;確定&lt;/button&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>document.body.insertAdjacentHTML(</span><span class="s7">'beforeend'</span><span class="s1">, modalHtml);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">        </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// Helper function to get the base URL of the current artifact</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> getArtifactBaseUrl = () =&gt; {</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// This attempts to get the base URL of the current artifact</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> url = window.location.href;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> urlObj = </span><span class="s10">new</span><span class="s1"> </span><span class="s12">URL</span><span class="s1">(url);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> baseUrl = urlObj.protocol + </span><span class="s7">'//'</span><span class="s1"> + urlObj.host + urlObj.pathname;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Remove trailing slash if present, for consistency</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (baseUrl.endsWith(</span><span class="s7">'/'</span><span class="s1">)) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>baseUrl = baseUrl.slice(</span><span class="s13">0</span><span class="s1">, -</span><span class="s13">1</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">return</span><span class="s1"> baseUrl;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// Firebase Initialization and Authentication</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> db, auth;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> userId = </span><span class="s10">null</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> isAuthReady = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> initializeFirebase = </span><span class="s10">async</span><span class="s1"> () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> { initializeApp, getFirestore, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } = window.</span><span class="s12">Firebase</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> app = initializeApp(firebaseConfig);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>db = getFirestore(app);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>auth = getAuth(app);</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">            </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">return</span><span class="s1"> </span><span class="s10">new</span><span class="s1"> </span><span class="s12">Promise</span><span class="s1">((resolve) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>onAuthStateChanged(auth, </span><span class="s10">async</span><span class="s1"> (user) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">if</span><span class="s1"> (user) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>userId = user.uid;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>} </span><span class="s10">else</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s10">try</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s10">if</span><span class="s1"> (initialAuthToken) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span></span><span class="s10">await</span><span class="s1"> signInWithCustomToken(auth, initialAuthToken);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>} </span><span class="s10">else</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span></span><span class="s10">await</span><span class="s1"> signInAnonymously(auth);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>userId = auth.currentUser?.uid || crypto.randomUUID();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>} </span><span class="s10">catch</span><span class="s1"> (error) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>console.error(</span><span class="s7">"Firebase authentication failed:"</span><span class="s1">, error);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>showMessage(</span><span class="s7">`Firebase 認證失敗: </span><span class="s1">${error.message}</span><span class="s7">`</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>userId = crypto.randomUUID();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>isAuthReady = </span><span class="s10">true</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>resolve();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// --- View components as functions that return HTML strings ---</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> </span><span class="s12">LessonPlanDisplay</span><span class="s1"> = (content) =&gt; </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div class="p-6 bg-white rounded-lg shadow-md mb-6"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;h2 class="text-2xl font-bold mb-4 text-gray-800"&gt;課程教學教案教學計劃&lt;/h2&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="whitespace-pre-wrap text-gray-700 leading-relaxed"&gt;</span><span class="s5">${content}</span><span class="s1">&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">        </span>`</span><span class="s5">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> </span><span class="s12">PPTOutlineDisplay</span><span class="s1"> = (content) =&gt; </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div class="p-6 bg-white rounded-lg shadow-md mb-6"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;h2 class="text-2xl font-bold mb-4 text-gray-800"&gt;PPT簡報內容與大綱&lt;/h2&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="whitespace-pre-wrap text-gray-700 leading-relaxed"&gt;</span><span class="s5">${content}</span><span class="s1">&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">        </span>`</span><span class="s5">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> </span><span class="s12">ContentSummaryDisplay</span><span class="s1"> = (content) =&gt; </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div class="p-6 bg-white rounded-lg shadow-md mb-6"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;h2 class="text-2xl font-bold mb-4 text-gray-800"&gt;內容摘要&lt;/h2&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="whitespace-pre-wrap text-gray-700 leading-relaxed"&gt;</span><span class="s5">${content}</span><span class="s1">&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">        </span>`</span><span class="s5">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> </span><span class="s12">KeyTermsDisplay</span><span class="s1"> = (content) =&gt; {</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s5"> (!content || content.length === </span><span class="s13">0</span><span class="s5">) </span><span class="s10">return</span><span class="s5"> </span><span class="s1">`&lt;div class="text-center text-gray-600"&gt;沒有找到關鍵詞彙。&lt;/div&gt;`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> listItems = content.map(item =&gt; </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;li class="mb-2"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;span class="font-semibold text-gray-800"&gt;</span><span class="s5">${item.term}</span><span class="s1">&lt;/span&gt;: </span><span class="s5">${item.definition}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/li&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>`</span><span class="s5">).join(</span><span class="s1">''</span><span class="s5">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">return</span><span class="s1"> </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="p-6 bg-white rounded-lg shadow-md mb-6"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;h2 class="text-2xl font-bold mb-4 text-gray-800"&gt;關鍵字詞解釋&lt;/h2&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;ul class="list-disc list-inside text-gray-700 leading-relaxed"&gt;</span><span class="s5">${listItems}</span><span class="s1">&lt;/ul&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s5"> </span><span class="s1">DiscussionQuestionsDisplay</span><span class="s5"> = (content) =&gt; </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>&lt;div class="p-6 bg-white rounded-lg shadow-md mb-6"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;h2 class="text-2xl font-bold mb-4 text-gray-800"&gt;延伸討論問題&lt;/h2&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="whitespace-pre-wrap text-gray-700 leading-relaxed"&gt;</span><span class="s5">${content}</span><span class="s1">&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">        </span>`</span><span class="s5">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> </span><span class="s12">FlashcardDisplay</span><span class="s1"> = (cards, isStudentView, studentName, contentId) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> currentCardIndex = </span><span class="s13">0</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> isFlipped = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> showMatchGame = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> matchedPairs = [];</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> selectedCards = [];</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">            </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> renderCard = () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> cardFront = cards[currentCardIndex].chinese;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> cardBack = cards[currentCardIndex].english;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">return</span><span class="s1"> </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="relative w-full h-64 perspective-1000 mb-6"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div id="flashcard-inner" class="relative w-full h-full transform-style-preserve-3d transition-transform duration-700 </span><span class="s5">${isFlipped ? </span><span class="s1">'rotate-y-180'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">" style="cursor: pointer;"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;div class="absolute w-full h-full backface-hidden bg-blue-500 text-white rounded-lg flex items-center justify-center text-4xl font-bold shadow-lg p-4"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span></span><span class="s5">${cardFront}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;div class="absolute w-full h-full backface-hidden bg-green-500 text-white rounded-lg flex items-center justify-center text-4xl font-bold shadow-lg p-4 rotate-y-180"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span></span><span class="s5">${cardBack}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> renderButtons = () =&gt; </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="flex justify-center space-x-4 mb-6"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;button id="prev-card" class="px-6 py-3 bg-gray-600 text-white rounded-lg shadow-lg hover:bg-gray-700 transition duration-300 ease-in-out transform hover:scale-105"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>上一張</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/button&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;button id="next-card" class="px-6 py-3 bg-gray-600 text-white rounded-lg shadow-lg hover:bg-gray-700 transition duration-300 ease-in-out transform hover:scale-105"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>下一張</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/button&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p5"><span class="s7"><span class="Apple-converted-space">                </span></span><span class="s1">${!isStudentView ? </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;button id="start-game" class="w-full px-6 py-3 bg-purple-600 text-white rounded-lg shadow-lg hover:bg-purple-700 transition duration-300 ease-in-out transform hover:scale-105"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>開始配對遊戲</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/button&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>`</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>`</span><span class="s5">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> renderGame = () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> gameCards = [...cards, ...cards].map((card, index) =&gt; ({</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>...card,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>id: </span><span class="s7">`</span><span class="s1">${card.chinese}</span><span class="s7">-</span><span class="s1">${card.english}</span><span class="s7">-</span><span class="s1">${index}</span><span class="s7">`</span><span class="s1">,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>isEnglish: index &gt;= cards.length</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>})).sort(() =&gt; </span><span class="s12">Math</span><span class="s1">.random() - </span><span class="s13">0.5</span><span class="s1">);</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> cardHtml = gameCards.map(card =&gt; </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div id="</span><span class="s5">${card.id}</span><span class="s1">" class="h-32 flex items-center justify-center rounded-lg shadow-md cursor-pointer bg-blue-400 text-white text-lg font-bold text-center p-2</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg"</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>data-chinese="</span><span class="s5">${card.chinese}</span><span class="s1">" data-english="</span><span class="s5">${card.english}</span><span class="s1">" data-is-english="</span><span class="s5">${card.isEnglish}</span><span class="s1">"</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&gt;</span></p>
<p class="p5"><span class="s7"><span class="Apple-converted-space">                        </span></span><span class="s1">${card.isEnglish ? card.english : card.chinese}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>`</span><span class="s5">).join(</span><span class="s1">''</span><span class="s5">);</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> backButton = </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;button id="back-to-cards" class="col-span-full mt-6 px-6 py-3 bg-gray-600 text-white rounded-lg shadow-lg hover:bg-gray-700 transition duration-300 ease-in-out transform hover:scale-105"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>返回字卡瀏覽</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/button&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>`</span><span class="s5">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">return</span><span class="s1"> </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div id="game-grid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s5">${cardHtml}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s5">${backButton}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> fullHtml = </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="p-6 bg-white rounded-lg shadow-md mb-6"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;h2 class="text-2xl font-bold mb-4 text-gray-800"&gt;Flash字卡&lt;/h2&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div id="flashcard-container"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s5">${renderCard()}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s5">${renderButtons()}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>`</span><span class="s5">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> handleCardEvents = () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> container = document.getElementById(</span><span class="s7">'flashcard-container'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (!container) </span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> updateDisplay = () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>container.innerHTML = showMatchGame ? renderGame() : renderCard() + renderButtons();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>setupCardEventListeners();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> setupCardEventListeners = () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">const</span><span class="s1"> innerCard = document.getElementById(</span><span class="s7">'flashcard-inner'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">if</span><span class="s1"> (innerCard) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>innerCard.addEventListener(</span><span class="s7">'click'</span><span class="s1">, () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>isFlipped = !isFlipped;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>updateDisplay();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">const</span><span class="s1"> nextButton = document.getElementById(</span><span class="s7">'next-card'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">if</span><span class="s1"> (nextButton) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>nextButton.addEventListener(</span><span class="s7">'click'</span><span class="s1">, () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>isFlipped = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>currentCardIndex = (currentCardIndex + </span><span class="s13">1</span><span class="s1">) % cards.length;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>updateDisplay();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">const</span><span class="s1"> prevButton = document.getElementById(</span><span class="s7">'prev-card'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">if</span><span class="s1"> (prevButton) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>prevButton.addEventListener(</span><span class="s7">'click'</span><span class="s1">, () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>isFlipped = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>currentCardIndex = (currentCardIndex - </span><span class="s13">1</span><span class="s1"> + cards.length) % cards.length;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>updateDisplay();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">const</span><span class="s1"> startGameButton = document.getElementById(</span><span class="s7">'start-game'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">if</span><span class="s1"> (startGameButton) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>startGameButton.addEventListener(</span><span class="s7">'click'</span><span class="s1">, () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>showMatchGame = </span><span class="s10">true</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>matchedPairs = [];</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>selectedCards = [];</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>updateDisplay();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">const</span><span class="s1"> backToCardsButton = document.getElementById(</span><span class="s7">'back-to-cards'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">if</span><span class="s1"> (backToCardsButton) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>backToCardsButton.addEventListener(</span><span class="s7">'click'</span><span class="s1">, () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>showMatchGame = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>updateDisplay();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">const</span><span class="s1"> gameGrid = document.getElementById(</span><span class="s7">'game-grid'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">if</span><span class="s1"> (gameGrid) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>gameGrid.querySelectorAll(</span><span class="s7">'div'</span><span class="s1">).forEach(cardEl =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>cardEl.addEventListener(</span><span class="s7">'click'</span><span class="s1">, () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span></span><span class="s10">if</span><span class="s1"> (cardEl.classList.contains(</span><span class="s7">'bg-gray-300'</span><span class="s1">) || selectedCards.includes(cardEl)) </span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span>cardEl.classList.remove(</span><span class="s7">'bg-blue-400'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span>cardEl.classList.add(</span><span class="s7">'bg-yellow-400'</span><span class="s1">);</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">                                </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span>selectedCards.push(cardEl);</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span></span><span class="s10">if</span><span class="s1"> (selectedCards.length === </span><span class="s13">2</span><span class="s1">) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                    </span></span><span class="s10">const</span><span class="s1"> [card1, card2] = selectedCards;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                    </span></span><span class="s10">const</span><span class="s1"> isMatch = (card1.dataset.chinese === card2.dataset.chinese &amp;&amp; card1.dataset.english === card2.dataset.english) &amp;&amp; card1.id !== card2.id;</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">                                    </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                    </span></span><span class="s10">if</span><span class="s1"> (isMatch) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                        </span>card1.classList.remove(</span><span class="s7">'bg-yellow-400'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                        </span>card1.classList.add(</span><span class="s7">'bg-gray-300'</span><span class="s1">, </span><span class="s7">'opacity-50'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                        </span>card2.classList.remove(</span><span class="s7">'bg-yellow-400'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                        </span>card2.classList.add(</span><span class="s7">'bg-gray-300'</span><span class="s1">, </span><span class="s7">'opacity-50'</span><span class="s1">);</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">                                        </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                        </span>matchedPairs.push(card1.id, card2.id);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                        </span>selectedCards = [];</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                        </span></span><span class="s10">if</span><span class="s1"> (matchedPairs.length === cards.length * </span><span class="s13">2</span><span class="s1">) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                            </span></span><span class="s10">const</span><span class="s1"> messageHtml = </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                                </span>&lt;div class="col-span-full text-center mt-6 text-2xl font-bold text-green-700"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                                    </span>恭喜！你完成了配對遊戲！</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                                </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                            </span>`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                            </span>gameGrid.insertAdjacentHTML(</span><span class="s7">'beforeend'</span><span class="s1">, messageHtml);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                        </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                    </span>} </span><span class="s10">else</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                        </span>setTimeout(() =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                            </span>card1.classList.remove(</span><span class="s7">'bg-yellow-400'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                            </span>card1.classList.add(</span><span class="s7">'bg-blue-400'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                            </span>card2.classList.remove(</span><span class="s7">'bg-yellow-400'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                            </span>card2.classList.add(</span><span class="s7">'bg-blue-400'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                            </span>selectedCards = [];</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                        </span>}, </span><span class="s13">1000</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                    </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>updateDisplay(); </span><span class="s14">// Initial render</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">return</span><span class="s1"> { html: fullHtml, setup: handleCardEvents };</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> </span><span class="s12">QuizDisplay</span><span class="s1"> = (quizData, quizId, isStudentView, studentName, contentId, showMessage) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> studentAnswers = {};</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> submitted = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> score = </span><span class="s13">0</span><span class="s1">;</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">            </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> renderQuiz = () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> questionHtml = quizData.map((q, index) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">let</span><span class="s1"> inputHtml;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">if</span><span class="s1"> (q.type === </span><span class="s7">'boolean'</span><span class="s1">) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>inputHtml = </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;div class="flex items-center space-x-4"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;label class="inline-flex items-center"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;input type="radio" name="q</span><span class="s5">${index}</span><span class="s1">" value="true" class="form-radio text-blue-600" </span><span class="s5">${submitted ? </span><span class="s1">'disabled'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1"> </span><span class="s5">${studentAnswers[index] === </span><span class="s1">'true'</span><span class="s5"> ? </span><span class="s1">'checked'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;span class="ml-2 text-gray-700"&gt;是&lt;/span&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;/label&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;label class="inline-flex items-center"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;input type="radio" name="q</span><span class="s5">${index}</span><span class="s1">" value="false" class="form-radio text-blue-600" </span><span class="s5">${submitted ? </span><span class="s1">'disabled'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1"> </span><span class="s5">${studentAnswers[index] === </span><span class="s1">'false'</span><span class="s5"> ? </span><span class="s1">'checked'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;span class="ml-2 text-gray-700"&gt;否&lt;/span&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;/label&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>} </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (q.type === </span><span class="s7">'multiple_choice'</span><span class="s1">) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>inputHtml = </span><span class="s7">`&lt;div class="space-y-2"&gt;`</span><span class="s1"> + q.options.map((option, optIndex) =&gt; </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;label class="inline-flex items-center w-full"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;input type="radio" name="q</span><span class="s5">${index}</span><span class="s1">" value="</span><span class="s5">${option}</span><span class="s1">" class="form-radio text-blue-600" </span><span class="s5">${submitted ? </span><span class="s1">'disabled'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1"> </span><span class="s5">${studentAnswers[index] === option ? </span><span class="s1">'checked'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;span class="ml-2 text-gray-700"&gt;</span><span class="s5">${option}</span><span class="s1">&lt;/span&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/label&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>`</span><span class="s5">).join(</span><span class="s1">''</span><span class="s5">) + </span><span class="s1">`&lt;/div&gt;`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>} </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (q.type === </span><span class="s7">'text'</span><span class="s1">) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>inputHtml = </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;input type="text" name="q</span><span class="s5">${index}</span><span class="s1">" class="mt-2 block w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="請輸入答案" value="</span><span class="s5">${studentAnswers[index] || </span><span class="s1">''</span><span class="s5">}</span><span class="s1">" </span><span class="s5">${submitted ? </span><span class="s1">'disabled'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">                    </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">const</span><span class="s1"> resultMessage = submitted ? </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="mt-2 text-sm font-medium </span><span class="s5">${</span><span class="s12">String</span><span class="s5">(studentAnswers[index]).trim().toLowerCase() === </span><span class="s12">String</span><span class="s5">(q.answer).trim().toLowerCase() ? </span><span class="s1">'text-green-600'</span><span class="s5"> : </span><span class="s1">'text-red-600'</span><span class="s5">}</span><span class="s1">"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>正確答案: </span><span class="s5">${q.answer}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/p&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>`</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">return</span><span class="s1"> </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;p class="text-lg font-semibold mb-2 text-gray-800"&gt;Q</span><span class="s5">${index + </span><span class="s13">1</span><span class="s5">}</span><span class="s1">: </span><span class="s5">${q.question}</span><span class="s1">&lt;/p&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s5">${inputHtml}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s5">${resultMessage}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>}).join(</span><span class="s7">''</span><span class="s1">);</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> submitButton = !submitted ? </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;button id="submit-quiz" type="button" class="mt-4 px-6 py-3 bg-green-600 text-white rounded-lg shadow-lg hover:bg-green-700 transition duration-300 ease-in-out transform hover:scale-105"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>提交測驗</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/button&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>`</span><span class="s5"> : </span><span class="s1">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="mt-4 p-4 bg-blue-100 border border-blue-300 rounded-lg text-blue-800"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="text-xl font-bold"&gt;你的分數: </span><span class="s5">${score}</span><span class="s1"> / </span><span class="s5">${quizData.length}</span><span class="s1">&lt;/p&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>`</span><span class="s5">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">return</span><span class="s1"> </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="p-6 bg-white rounded-lg shadow-md mb-6"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;h2 class="text-2xl font-bold mb-4 text-gray-800"&gt;測驗&lt;/h2&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s5">${isStudentView ? </span><span class="s1">`&lt;p class="text-gray-600 mb-4"&gt;測驗ID: &lt;span class="font-mono text-blue-700"&gt;</span><span class="s5">${quizId}</span><span class="s1">&lt;/span&gt;&lt;/p&gt;`</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;form id="quiz-form" onsubmit="event.preventDefault()"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s5">${questionHtml}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s5">${submitButton}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/form&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>};</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">            </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> handleQuizEvents = () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> quizForm = document.getElementById(</span><span class="s7">'quiz-form'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (!quizForm) </span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>quizForm.addEventListener(</span><span class="s7">'change'</span><span class="s1">, (e) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">const</span><span class="s1"> input = e.target;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">const</span><span class="s1"> questionIndex = parseInt(input.name.replace(</span><span class="s7">'q'</span><span class="s1">, </span><span class="s7">''</span><span class="s1">));</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>studentAnswers[questionIndex] = input.value;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> submitButton = document.getElementById(</span><span class="s7">'submit-quiz'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (submitButton) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>submitButton.addEventListener(</span><span class="s7">'click'</span><span class="s1">, </span><span class="s10">async</span><span class="s1"> () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s10">if</span><span class="s1"> (!userId) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>showMessage(</span><span class="s7">'無法提交測驗，用戶ID未準備好。'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s10">if</span><span class="s1"> (!studentName &amp;&amp; isStudentView) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>showMessage(</span><span class="s7">'請輸入您的姓名才能提交測驗。'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>}</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s10">let</span><span class="s1"> correctCount = </span><span class="s13">0</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s10">const</span><span class="s1"> answersToStore = {};</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>quizData.forEach((q, index) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s10">const</span><span class="s1"> studentAns = studentAnswers[index] ? </span><span class="s12">String</span><span class="s1">(studentAnswers[index]).trim().toLowerCase() : </span><span class="s7">''</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s10">const</span><span class="s1"> correctAns = </span><span class="s12">String</span><span class="s1">(q.answer).trim().toLowerCase();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s10">if</span><span class="s1"> (studentAns === correctAns) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span>correctCount++;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>answersToStore[index] = {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span>question: q.question,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span>studentAnswer: studentAnswers[index] || </span><span class="s7">''</span><span class="s1">,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span>correctAnswer: q.answer,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span>isCorrect: studentAns === correctAns</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>};</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>});</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>score = correctCount;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>submitted = </span><span class="s10">true</span><span class="s1">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s10">try</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s10">const</span><span class="s1"> { doc, setDoc } = window.</span><span class="s12">Firebase</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s10">const</span><span class="s1"> responseDocRef = doc(db, </span><span class="s7">`artifacts/</span><span class="s1">${appId}</span><span class="s7">/public/data/generatedContent/</span><span class="s1">${contentId}</span><span class="s7">/quizResponses`</span><span class="s1">, userId);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s10">await</span><span class="s1"> setDoc(responseDocRef, {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span>quizId: contentId,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span>studentSessionId: userId,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span>studentName: studentName || </span><span class="s7">`匿名學生 </span><span class="s1">${userId.substring(</span><span class="s13">0</span><span class="s1">, </span><span class="s13">8</span><span class="s1">)}</span><span class="s7">`</span><span class="s1">,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span>answers: answersToStore,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span>score: correctCount,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span>totalQuestions: quizData.length,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                                </span>submittedAt: </span><span class="s10">new</span><span class="s1"> </span><span class="s12">Date</span><span class="s1">()</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>showMessage(</span><span class="s7">'測驗已提交！'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>} </span><span class="s10">catch</span><span class="s1"> (error) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>console.error(</span><span class="s7">"Error submitting quiz:"</span><span class="s1">, error);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>showMessage(</span><span class="s7">`提交測驗時發生錯誤: </span><span class="s1">${error.message}</span><span class="s7">`</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>}</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>renderApp();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>};</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">            </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">return</span><span class="s1"> { html: renderQuiz(), setup: handleQuizEvents };</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> </span><span class="s12">TeacherView</span><span class="s1"> = (contentId, showMessage) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> studentRecords = [];</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> loadingRecords = </span><span class="s10">true</span><span class="s1">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> renderRecords = () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (loadingRecords) {</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s10">return</span><span class="s5"> </span><span class="s1">`&lt;div class="text-center text-gray-600 mt-4"&gt;載入學生紀錄中...&lt;/div&gt;`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> recordsHtml = studentRecords.map(record =&gt; </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="font-medium text-gray-700"&gt;學生: </span><span class="s5">${record.studentName}</span><span class="s1"> (ID: </span><span class="s5">${record.studentSessionId.substring(</span><span class="s13">0</span><span class="s5">, </span><span class="s13">8</span><span class="s5">)}</span><span class="s1">...)&lt;/p&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="text-gray-600"&gt;分數: </span><span class="s5">${record.score}</span><span class="s1"> / </span><span class="s5">${record.totalQuestions}</span><span class="s1">&lt;/p&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="text-gray-600 text-sm"&gt;提交時間: </span><span class="s5">${record.submittedAt?.toDate().toLocaleString()}</span><span class="s1">&lt;/p&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="mt-2 text-sm"&gt;</span></p>
<p class="p5"><span class="s7"><span class="Apple-converted-space">                            </span></span><span class="s1">${</span><span class="s12">Object</span><span class="s1">.values(record.answers).map((ans, idx) =&gt; </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;div class="mb-1 </span><span class="s5">${ans.isCorrect ? </span><span class="s1">'text-green-700'</span><span class="s5"> : </span><span class="s1">'text-red-700'</span><span class="s5">}</span><span class="s1">"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;p&gt;Q</span><span class="s5">${idx + </span><span class="s13">1</span><span class="s5">}</span><span class="s1">: </span><span class="s5">${ans.question}</span><span class="s1">&lt;/p&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;p&gt;你的答案: </span><span class="s5">${ans.studentAnswer}</span><span class="s1">&lt;/p&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;p&gt;正確答案: </span><span class="s5">${ans.correctAnswer}</span><span class="s1">&lt;/p&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>`</span><span class="s5">).join(</span><span class="s1">''</span><span class="s5">)}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>`</span><span class="s5">).join(</span><span class="s1">''</span><span class="s5">);</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">return</span><span class="s1"> </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="mt-8 p-4 bg-gray-50 rounded-lg shadow-inner"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;h3 class="text-xl font-semibold mb-4 text-gray-800"&gt;學生作答紀錄 (測驗ID: </span><span class="s5">${contentId}</span><span class="s1">)&lt;/h3&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="text-sm text-gray-600 mb-4"&gt;您的用戶ID: &lt;span class="font-mono text-blue-700"&gt;</span><span class="s5">${userId}</span><span class="s1">&lt;/span&gt;&lt;/p&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s5">${studentRecords.length === </span><span class="s13">0</span><span class="s5"> ? </span><span class="s1">'&lt;p class="text-gray-600"&gt;目前沒有學生作答紀錄。&lt;/p&gt;'</span><span class="s5"> : </span><span class="s1">`&lt;div class="space-y-4"&gt;</span><span class="s5">${recordsHtml}</span><span class="s1">&lt;/div&gt;`</span><span class="s5">}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> setupRecordsListener = () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (!db || !contentId || !isAuthReady) </span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> { collection, onSnapshot } = window.</span><span class="s12">Firebase</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> q = collection(db, </span><span class="s7">`artifacts/</span><span class="s1">${appId}</span><span class="s7">/public/data/generatedContent/</span><span class="s1">${contentId}</span><span class="s7">/quizResponses`</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>onSnapshot(q, (snapshot) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>studentRecords = snapshot.docs.map(doc =&gt; ({ id: doc.id, ...doc.data() }));</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>studentRecords.sort((a, b) =&gt; (b.submittedAt?.toDate() || </span><span class="s13">0</span><span class="s1">) - (a.submittedAt?.toDate() || </span><span class="s13">0</span><span class="s1">));</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>loadingRecords = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">                    </span>renderApp(); </span><span class="s1">// Re-render to show updated records</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>}, (error) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>console.error(</span><span class="s7">"Error fetching student records:"</span><span class="s1">, error);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>showMessage(</span><span class="s7">`載入學生紀錄時發生錯誤: </span><span class="s1">${error.message}</span><span class="s7">`</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>loadingRecords = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">                    </span>renderApp(); </span><span class="s1">// Re-render to show error message</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">return</span><span class="s1"> { html: renderRecords(), setup: setupRecordsListener };</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> </span><span class="s12">QrCodeCanvas</span><span class="s1"> = (value, size) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> canvasId = </span><span class="s7">`qrcode-canvas-</span><span class="s1">${generateUniqueId()}</span><span class="s7">`</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>setTimeout(() =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> container = document.getElementById(canvasId);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (container &amp;&amp; </span><span class="s10">typeof</span><span class="s1"> </span><span class="s12">QRCode</span><span class="s1"> !== </span><span class="s7">'undefined'</span><span class="s1">) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">new</span><span class="s1"> </span><span class="s12">QRCode</span><span class="s1">(container, {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>text: value,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>width: size,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>height: size,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>colorDark : </span><span class="s7">"#000000"</span><span class="s1">,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>colorLight : </span><span class="s7">"#ffffff"</span><span class="s1">,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>correctLevel : </span><span class="s12">QRCode</span><span class="s1">.</span><span class="s12">CorrectLevel</span><span class="s1">.</span><span class="s12">H</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">            </span>}, </span><span class="s13">0</span><span class="s5">); </span><span class="s1">// Defer to ensure the container is in the DOM</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s10">return</span><span class="s5"> </span><span class="s1">`&lt;div id="</span><span class="s5">${canvasId}</span><span class="s1">" class="flex justify-center"&gt;&lt;/div&gt;`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> generatedContent = </span><span class="s10">null</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> selectedFeature = </span><span class="s7">''</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> inputText = </span><span class="s7">''</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> urlInput = </span><span class="s7">''</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> selectedGrade = </span><span class="s7">''</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> selectedSubject = </span><span class="s7">''</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> selectedDifficulty = </span><span class="s7">''</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> loading = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> qrCodeData = </span><span class="s7">''</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> qrCodeTitle = </span><span class="s7">''</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> showQrCodeModal = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">        </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> renderTeacherApp = () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> generatedContentHtml = </span><span class="s7">''</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> studentPreviewButtonHtml = </span><span class="s7">''</span><span class="s1">;</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">            </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> teacherViewHtml = </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8 font-sans"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;h1 class="text-4xl font-extrabold text-center text-gray-900 mb-8"&gt;教師教學輔助工具&lt;/h1&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;p class="text-center text-sm text-gray-600 mb-4"&gt;您的用戶ID: &lt;span class="font-mono text-blue-700"&gt;</span><span class="s5">${userId || </span><span class="s1">'載入中...'</span><span class="s5">}</span><span class="s1">&lt;/span&gt;&lt;/p&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-white p-6 rounded-lg shadow-xl mb-8"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;h2 class="text-2xl font-bold text-gray-800 mb-4"&gt;輸入內容&lt;/h2&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="mb-4"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;label for="urlInput" class="block text-gray-700 text-sm font-bold mb-2"&gt;網頁/影片連結 (目前僅支援手動複製內容):&lt;/label&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;div class="flex space-x-2"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;input type="text" id="urlInput" class="flex-grow p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="貼上網頁或影片連結" value="</span><span class="s5">${urlInput}</span><span class="s1">"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;button id="fetch-url" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>讀取內容</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;/button&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="mb-4"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;label for="inputText" class="block text-gray-700 text-sm font-bold mb-2"&gt;或手動輸入/貼上內容:&lt;/label&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;textarea id="inputText" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 h-40 resize-y" placeholder="請在此處輸入或貼上網頁/影片的文字內容..."&gt;</span><span class="s5">${inputText}</span><span class="s1">&lt;/textarea&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;h2 class="text-2xl font-bold text-gray-800 mb-4 mt-6"&gt;選擇生成選項&lt;/h2&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;label for="grade" class="block text-gray-700 text-sm font-bold mb-2"&gt;年級:&lt;/label&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;select id="grade" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="" </span><span class="s5">${selectedGrade === </span><span class="s1">''</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;選擇年級&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="小學" </span><span class="s5">${selectedGrade === </span><span class="s1">'小學'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;小學&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="國中" </span><span class="s5">${selectedGrade === </span><span class="s1">'國中'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;國中&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="高中" </span><span class="s5">${selectedGrade === </span><span class="s1">'高中'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;高中&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="大學" </span><span class="s5">${selectedGrade === </span><span class="s1">'大學'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;大學&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;/select&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;label for="subject" class="block text-gray-700 text-sm font-bold mb-2"&gt;領域:&lt;/label&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;select id="subject" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="" </span><span class="s5">${selectedSubject === </span><span class="s1">''</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;選擇領域&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="語文" </span><span class="s5">${selectedSubject === </span><span class="s1">'語文'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;語文&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="數學" </span><span class="s5">${selectedSubject === </span><span class="s1">'數學'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;數學&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="自然科學" </span><span class="s5">${selectedSubject === </span><span class="s1">'自然科學'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;自然科學&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="社會" </span><span class="s5">${selectedSubject === </span><span class="s1">'社會'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;社會&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="藝術" </span><span class="s5">${selectedSubject === </span><span class="s1">'藝術'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;藝術&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="健康與體育" </span><span class="s5">${selectedSubject === </span><span class="s1">'健康與體育'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;健康與體育&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="綜合活動" </span><span class="s5">${selectedSubject === </span><span class="s1">'綜合活動'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;綜合活動&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;/select&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;label for="difficulty" class="block text-gray-700 text-sm font-bold mb-2"&gt;難易度:&lt;/label&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;select id="difficulty" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="" </span><span class="s5">${selectedDifficulty === </span><span class="s1">''</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;選擇難易度&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="簡單" </span><span class="s5">${selectedDifficulty === </span><span class="s1">'簡單'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;簡單&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="中等" </span><span class="s5">${selectedDifficulty === </span><span class="s1">'中等'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;中等&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;option value="困難" </span><span class="s5">${selectedDifficulty === </span><span class="s1">'困難'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;困難&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;/select&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="mb-6"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;label for="feature" class="block text-gray-700 text-sm font-bold mb-2"&gt;要生成的資料類型:&lt;/label&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;select id="feature" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value="" </span><span class="s5">${selectedFeature === </span><span class="s1">''</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;選擇類型&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value="lessonPlan" </span><span class="s5">${selectedFeature === </span><span class="s1">'lessonPlan'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;課程教學教案教學計劃&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value="pptOutline" </span><span class="s5">${selectedFeature === </span><span class="s1">'pptOutline'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;PPT簡報內容與大綱&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value="contentSummary" </span><span class="s5">${selectedFeature === </span><span class="s1">'contentSummary'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;內容摘要&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value="keyTerms" </span><span class="s5">${selectedFeature === </span><span class="s1">'keyTerms'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;關鍵字詞解釋&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value="discussionQuestions" </span><span class="s5">${selectedFeature === </span><span class="s1">'discussionQuestions'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;延伸討論問題&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value="flashcards" </span><span class="s5">${selectedFeature === </span><span class="s1">'flashcards'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;Flash字卡 (中英文對照)&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value="quizBoolean" </span><span class="s5">${selectedFeature === </span><span class="s1">'quizBoolean'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;測驗 (是非題)&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value="quizMultipleChoice" </span><span class="s5">${selectedFeature === </span><span class="s1">'quizMultipleChoice'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;測驗 (單選題)&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;option value="quizText" </span><span class="s5">${selectedFeature === </span><span class="s1">'quizText'</span><span class="s5"> ? </span><span class="s1">'selected'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;測驗 (問答題)&lt;/option&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/select&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;button id="generate-content" class="w-full px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-300 ease-in-out transform hover:scale-105" </span><span class="s5">${loading || !isAuthReady ? </span><span class="s1">'disabled'</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span><span class="s1">&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s5">${loading ? </span><span class="s1">'生成中...'</span><span class="s5"> : </span><span class="s1">'生成教學內容'</span><span class="s5">}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s5">${loading ? </span><span class="s1">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="text-center text-blue-600 text-xl font-semibold mt-8"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;div class="custom-loader inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mr-3"&gt;&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>正在生成內容，請稍候...</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>`</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span></p>
<p class="p5"><span class="s7"><span class="Apple-converted-space">                    </span></span><span class="s1">${generatedContent ? </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="mt-8"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;h2 class="text-3xl font-bold text-gray-800 mb-6 text-center"&gt;生成結果&lt;/h2&gt;</span></p>
<p class="p5"><span class="s7"><span class="Apple-converted-space">                            </span></span><span class="s1">${renderGeneratedContentHtml(generatedContent)}</span></p>
<p class="p5"><span class="s7"><span class="Apple-converted-space">                            </span></span><span class="s1">${(generatedContent.type === </span><span class="s7">'flashcards'</span><span class="s1"> || generatedContent.type.startsWith(</span><span class="s7">'quiz'</span><span class="s1">)) ? </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;div class="flex justify-center mt-6"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;button id="preview-student-activity" class="px-8 py-4 bg-orange-500 text-white font-bold rounded-lg shadow-lg hover:bg-orange-600 transition duration-300 ease-in-out transform hover:scale-105"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                        </span>預覽學生活動 (新分頁)</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                    </span>&lt;/button&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>`</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>`</span><span class="s5"> : </span><span class="s1">''</span><span class="s5">}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">return</span><span class="s1"> teacherViewHtml;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> renderStudentApp = (contentId, initialStudentName) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> studentName = initialStudentName || </span><span class="s7">''</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> hasEnteredName = studentName !== </span><span class="s7">''</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> content = </span><span class="s10">null</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> loadingContent = </span><span class="s10">true</span><span class="s1">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> renderNameInput = () =&gt; </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="bg-white p-6 rounded-lg shadow-xl mb-8 text-center"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;h2 class="text-2xl font-bold text-gray-800 mb-4"&gt;請輸入您的姓名&lt;/h2&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;p class="text-gray-600 mb-4"&gt;請輸入您的姓名以開始活動或測驗。&lt;/p&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="mb-4"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;input type="text" id="studentNameInput" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="請在此輸入您的姓名" value="</span><span class="s5">${studentName}</span><span class="s1">"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;button id="submit-name" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>確認並進入活動</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/button&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>`</span><span class="s5">;</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">            </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> renderContentDisplay = () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (loadingContent) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">return</span><span class="s1"> </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="text-center text-blue-600 text-xl font-semibold mt-8"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;div class="custom-loader inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mr-3"&gt;&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>正在載入內容，請稍候...</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (!content) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">return</span><span class="s1"> </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="text-center text-red-600 text-xl font-semibold mt-8"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>找不到指定的教學內容。請確認連結是否正確。</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">                </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> contentHtml = renderGeneratedContentHtml(content, </span><span class="s10">true</span><span class="s1">, studentName);</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">                </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">return</span><span class="s1"> </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-white p-6 rounded-lg shadow-xl mb-8"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;h2 class="text-2xl font-bold text-gray-800 mb-4"&gt;您的資訊&lt;/h2&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="text-gray-700"&gt;姓名: &lt;span class="font-semibold"&gt;</span><span class="s5">${studentName}</span><span class="s1">&lt;/span&gt;&lt;/p&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="text-gray-700"&gt;活動ID: &lt;span class="font-mono text-blue-700"&gt;</span><span class="s5">${contentId}</span><span class="s1">&lt;/span&gt;&lt;/p&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="mt-8"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;h2 class="text-3xl font-bold text-gray-800 mb-6 text-center"&gt;教學內容&lt;/h2&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s5">${contentHtml}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> fullHtml = </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8 font-sans"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;h1 class="text-4xl font-extrabold text-center text-gray-900 mb-8"&gt;學生學習工具&lt;/h1&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;p class="text-center text-sm text-gray-600 mb-4"&gt;您的用戶ID: &lt;span class="font-mono text-blue-700"&gt;</span><span class="s5">${userId || </span><span class="s1">'載入中...'</span><span class="s5">}</span><span class="s1">&lt;/span&gt;&lt;/p&gt;</span></p>
<p class="p5"><span class="s7"><span class="Apple-converted-space">                    </span></span><span class="s1">${!hasEnteredName ? renderNameInput() : renderContentDisplay()}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>`</span><span class="s5">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> setupStudentEvents = () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> nameInput = document.getElementById(</span><span class="s7">'studentNameInput'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (nameInput) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>nameInput.addEventListener(</span><span class="s7">'input'</span><span class="s1">, (e) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>studentName = e.target.value;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> submitNameButton = document.getElementById(</span><span class="s7">'submit-name'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (submitNameButton) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>submitNameButton.addEventListener(</span><span class="s7">'click'</span><span class="s1">, </span><span class="s10">async</span><span class="s1"> () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s10">if</span><span class="s1"> (studentName.trim() === </span><span class="s7">''</span><span class="s1">) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>showMessage(</span><span class="s7">'請輸入您的姓名。'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>hasEnteredName = </span><span class="s10">true</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s10">await</span><span class="s1"> loadContentForStudent();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>renderApp();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> loadContentForStudent = </span><span class="s10">async</span><span class="s1"> () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (!db || !contentId || !isAuthReady) </span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>loadingContent = </span><span class="s10">true</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> { doc, onSnapshot } = window.</span><span class="s12">Firebase</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> docRef = doc(db, </span><span class="s7">`artifacts/</span><span class="s1">${appId}</span><span class="s7">/public/data/generatedContent`</span><span class="s1">, contentId);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>onSnapshot(docRef, (docSnap) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">if</span><span class="s1"> (docSnap.exists()) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>content = { id: docSnap.id, ...docSnap.data() };</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>showMessage(</span><span class="s7">'內容已載入。'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>} </span><span class="s10">else</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>showMessage(</span><span class="s7">'找不到此內容。'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>content = </span><span class="s10">null</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>loadingContent = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">                    </span>renderApp(); </span><span class="s1">// Re-render to show content or error</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>}, (error) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>console.error(</span><span class="s7">"Error fetching content:"</span><span class="s1">, error);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>showMessage(</span><span class="s7">`載入內容時發生錯誤: </span><span class="s1">${error.message}</span><span class="s7">`</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>content = </span><span class="s10">null</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>loadingContent = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>renderApp();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">return</span><span class="s1"> { html: fullHtml, setup: setupStudentEvents };</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> renderGeneratedContentHtml = (content, isStudentView = </span><span class="s10">false</span><span class="s1">, studentName = </span><span class="s7">''</span><span class="s1">) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (!content) </span><span class="s10">return</span><span class="s1"> </span><span class="s7">''</span><span class="s1">;</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">            </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">switch</span><span class="s1"> (content.type) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'lessonPlan'</span><span class="s1">: </span><span class="s10">return</span><span class="s1"> </span><span class="s12">LessonPlanDisplay</span><span class="s1">(content.data);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'pptOutline'</span><span class="s1">: </span><span class="s10">return</span><span class="s1"> </span><span class="s12">PPTOutlineDisplay</span><span class="s1">(content.data);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'contentSummary'</span><span class="s1">: </span><span class="s10">return</span><span class="s1"> </span><span class="s12">ContentSummaryDisplay</span><span class="s1">(content.data);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'keyTerms'</span><span class="s1">: </span><span class="s10">return</span><span class="s1"> </span><span class="s12">KeyTermsDisplay</span><span class="s1">(content.data);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'discussionQuestions'</span><span class="s1">: </span><span class="s10">return</span><span class="s1"> </span><span class="s12">DiscussionQuestionsDisplay</span><span class="s1">(content.data);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'flashcards'</span><span class="s1">: {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">const</span><span class="s1"> { html, setup } = </span><span class="s12">FlashcardDisplay</span><span class="s1">(content.data, isStudentView, studentName, content.id);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>setTimeout(setup, </span><span class="s13">0</span><span class="s1">); </span><span class="s14">// Defer event setup</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">return</span><span class="s1"> html;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'quizBoolean'</span><span class="s1">:</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s10">case</span><span class="s5"> </span><span class="s1">'quizMultipleChoice'</span><span class="s5">:</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'quizText'</span><span class="s1">: {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">const</span><span class="s1"> { html, setup } = </span><span class="s12">QuizDisplay</span><span class="s1">(content.data, content.id, isStudentView, studentName, content.id, showMessage);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>setTimeout(setup, </span><span class="s13">0</span><span class="s1">); </span><span class="s14">// Defer event setup</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">const</span><span class="s1"> teacherHtml = isStudentView ? </span><span class="s7">''</span><span class="s1"> : </span><span class="s12">TeacherView</span><span class="s1">(content.id, showMessage).html;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>setTimeout(</span><span class="s12">TeacherView</span><span class="s1">(content.id, showMessage).setup, </span><span class="s13">0</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">return</span><span class="s1"> html + teacherHtml;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s10">default</span><span class="s5">: </span><span class="s10">return</span><span class="s5"> </span><span class="s1">`&lt;div class="p-6 bg-white rounded-lg shadow-md mb-6 text-gray-700"&gt;無法顯示此類型內容。&lt;/div&gt;`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> setupTeacherEvents = () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> root = document.getElementById(</span><span class="s7">'app-root'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (!root) </span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> inputElements = {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>url: document.getElementById(</span><span class="s7">'urlInput'</span><span class="s1">),</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>text: document.getElementById(</span><span class="s7">'inputText'</span><span class="s1">),</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>grade: document.getElementById(</span><span class="s7">'grade'</span><span class="s1">),</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>subject: document.getElementById(</span><span class="s7">'subject'</span><span class="s1">),</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>difficulty: document.getElementById(</span><span class="s7">'difficulty'</span><span class="s1">),</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>feature: document.getElementById(</span><span class="s7">'feature'</span><span class="s1">)</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">const</span><span class="s1"> key </span><span class="s10">in</span><span class="s1"> inputElements) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (inputElements[key]) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>inputElements[key].addEventListener(</span><span class="s7">'input'</span><span class="s1">, (e) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s10">const</span><span class="s1"> value = e.target.value;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s10">switch</span><span class="s1">(key) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'url'</span><span class="s1">: urlInput = value; </span><span class="s10">break</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'text'</span><span class="s1">: inputText = value; </span><span class="s10">break</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'grade'</span><span class="s1">: selectedGrade = value; </span><span class="s10">break</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'subject'</span><span class="s1">: selectedSubject = value; </span><span class="s10">break</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'difficulty'</span><span class="s1">: selectedDifficulty = value; </span><span class="s10">break</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'feature'</span><span class="s1">: selectedFeature = value; </span><span class="s10">break</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> fetchUrlButton = document.getElementById(</span><span class="s7">'fetch-url'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (fetchUrlButton) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>fetchUrlButton.addEventListener(</span><span class="s7">'click'</span><span class="s1">, () =&gt; {</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">                    </span>showMessage(</span><span class="s1">'由於瀏覽器安全限制，無法直接從網頁連結自動抓取內容。請手動複製網頁或影片的文字內容，並貼到下方的「輸入內容」文字框中。'</span><span class="s5">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> generateButton = document.getElementById(</span><span class="s7">'generate-content'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (generateButton) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>generateButton.addEventListener(</span><span class="s7">'click'</span><span class="s1">, handleGenerateContent);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> previewButton = document.getElementById(</span><span class="s7">'preview-student-activity'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (previewButton) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>previewButton.addEventListener(</span><span class="s7">'click'</span><span class="s1">, () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">if</span><span class="s1"> (generatedContent &amp;&amp; (generatedContent.type === </span><span class="s7">'flashcards'</span><span class="s1"> || generatedContent.type.startsWith(</span><span class="s7">'quiz'</span><span class="s1">))) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s10">const</span><span class="s1"> previewUrl = </span><span class="s7">`</span><span class="s1">${getArtifactBaseUrl()}</span><span class="s7">?student=true&amp;contentId=</span><span class="s1">${generatedContent.id}</span><span class="s7">`</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>window.open(previewUrl, </span><span class="s7">'_blank'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>} </span><span class="s10">else</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>showMessage(</span><span class="s7">'此內容類型無法預覽學生活動。'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">        </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> handleGenerateContent = </span><span class="s10">async</span><span class="s1"> () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (!inputText.trim()) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>showMessage(</span><span class="s7">'請先讀取網頁內容或手動輸入文字。'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (!selectedFeature) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>showMessage(</span><span class="s7">'請選擇要生成的資料類型。'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (!isAuthReady || !db || !auth || !userId) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>showMessage(</span><span class="s7">'Firebase 尚未初始化或認證。請稍候再試。'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>loading = </span><span class="s10">true</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>generatedContent = </span><span class="s10">null</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>qrCodeData = </span><span class="s7">''</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>showQrCodeModal = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">            </span>renderApp(); </span><span class="s1">// Re-render to show loading state</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> prompt = </span><span class="s7">`根據以下內容：\n\n</span><span class="s1">${inputText}</span><span class="s7">\n\n`</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> responseSchema = </span><span class="s10">null</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> responseMimeType = </span><span class="s7">"text/plain"</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> contentId = generateUniqueId();</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s5"> collectionPath = </span><span class="s1">`artifacts/</span><span class="s5">${appId}</span><span class="s1">/public/data/generatedContent`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">let</span><span class="s1"> contentType = selectedFeature;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (selectedGrade) { prompt += </span><span class="s7">`年級: </span><span class="s1">${selectedGrade}</span><span class="s7">年級。\n`</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (selectedSubject) { prompt += </span><span class="s7">`領域: </span><span class="s1">${selectedSubject}</span><span class="s7">。\n`</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (selectedDifficulty) { prompt += </span><span class="s7">`難易度: </span><span class="s1">${selectedDifficulty}</span><span class="s7">。\n`</span><span class="s1">; }</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">try</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">switch</span><span class="s1"> (selectedFeature) {</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s10">case</span><span class="s5"> </span><span class="s1">'lessonPlan'</span><span class="s5">: prompt += </span><span class="s1">'請生成一個詳細的課程教學教案教學計劃，包含目標、材料、步驟、評估。'</span><span class="s5">; </span><span class="s10">break</span><span class="s5">;</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s10">case</span><span class="s5"> </span><span class="s1">'pptOutline'</span><span class="s5">: prompt += </span><span class="s1">'請生成一個詳細的PPT簡報內容與大綱，包含各投影片的標題和重點。'</span><span class="s5">; </span><span class="s10">break</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'quizBoolean'</span><span class="s1">:</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'quizMultipleChoice'</span><span class="s1">:</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'quizText'</span><span class="s1">:</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">                        </span>prompt += selectedFeature === </span><span class="s1">'quizBoolean'</span><span class="s5"> ? </span><span class="s1">`請根據內容生成3到5題的是非題測驗。每題都要有題目和正確答案（true/false）。格式應為JSON陣列，每個物件包含'type' (boolean), 'question', 'answer'。`</span><span class="s5"> :</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">                                  </span>selectedFeature === </span><span class="s1">'quizMultipleChoice'</span><span class="s5"> ? </span><span class="s1">`請根據內容生成3到5題的單選題測驗。每題都要有題目、至少3個選項和正確答案。格式應為JSON陣列，每個物件包含'type' (multiple_choice), 'question', 'options' (陣列), 'answer'。`</span><span class="s5"> :</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">                                  </span></span><span class="s1">`請根據內容生成3到5題的問答題測驗。每題都要有題目和正確答案。格式應為JSON陣列，每個物件包含'type' (text), 'question', 'answer'。`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>responseSchema = {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                            </span>type: </span><span class="s7">"ARRAY"</span><span class="s1">, items: { type: </span><span class="s7">"OBJECT"</span><span class="s1">, properties: { </span><span class="s7">"type"</span><span class="s1">: { </span><span class="s7">"type"</span><span class="s1">: </span><span class="s7">"STRING"</span><span class="s1"> }, </span><span class="s7">"question"</span><span class="s1">: { </span><span class="s7">"type"</span><span class="s1">: </span><span class="s7">"STRING"</span><span class="s1"> }, ...(selectedFeature === </span><span class="s7">'quizMultipleChoice'</span><span class="s1"> &amp;&amp; { </span><span class="s7">"options"</span><span class="s1">: { </span><span class="s7">"type"</span><span class="s1">: </span><span class="s7">"ARRAY"</span><span class="s1">, </span><span class="s7">"items"</span><span class="s1">: { </span><span class="s7">"type"</span><span class="s1">: </span><span class="s7">"STRING"</span><span class="s1"> } } }), </span><span class="s7">"answer"</span><span class="s1">: { </span><span class="s7">"type"</span><span class="s1">: </span><span class="s7">"STRING"</span><span class="s1"> } }, required: [</span><span class="s7">"type"</span><span class="s1">, </span><span class="s7">"question"</span><span class="s1">, </span><span class="s7">"answer"</span><span class="s1">] }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>};</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>responseMimeType = </span><span class="s7">"application/json"</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s10">break</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'flashcards'</span><span class="s1">:</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">                        </span>prompt += </span><span class="s1">`請根據內容生成3到10個中英文對照的flash字卡。格式應為JSON陣列，每個物件包含'chinese'和'english'。`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>responseSchema = { type: </span><span class="s7">"ARRAY"</span><span class="s1">, items: { type: </span><span class="s7">"OBJECT"</span><span class="s1">, properties: { </span><span class="s7">"chinese"</span><span class="s1">: { </span><span class="s7">"type"</span><span class="s1">: </span><span class="s7">"STRING"</span><span class="s1"> }, </span><span class="s7">"english"</span><span class="s1">: { </span><span class="s7">"type"</span><span class="s1">: </span><span class="s7">"STRING"</span><span class="s1"> } }, required: [</span><span class="s7">"chinese"</span><span class="s1">, </span><span class="s7">"english"</span><span class="s1">] } };</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>responseMimeType = </span><span class="s7">"application/json"</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s10">break</span><span class="s1">;</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s10">case</span><span class="s5"> </span><span class="s1">'contentSummary'</span><span class="s5">: prompt += </span><span class="s1">'請將以下內容總結成200字以內的摘要。'</span><span class="s5">; </span><span class="s10">break</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">case</span><span class="s1"> </span><span class="s7">'keyTerms'</span><span class="s1">:</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">                        </span>prompt += </span><span class="s1">`請從以下內容中提取5到10個關鍵詞彙，並為每個詞彙提供簡潔的解釋。格式應為JSON陣列，每個物件包含'term'和'definition'。`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>responseSchema = { type: </span><span class="s7">"ARRAY"</span><span class="s1">, items: { type: </span><span class="s7">"OBJECT"</span><span class="s1">, properties: { </span><span class="s7">"term"</span><span class="s1">: { </span><span class="s7">"type"</span><span class="s1">: </span><span class="s7">"STRING"</span><span class="s1"> }, </span><span class="s7">"definition"</span><span class="s1">: { </span><span class="s7">"type"</span><span class="s1">: </span><span class="s7">"STRING"</span><span class="s1"> } }, required: [</span><span class="s7">"term"</span><span class="s1">, </span><span class="s7">"definition"</span><span class="s1">] } };</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>responseMimeType = </span><span class="s7">"application/json"</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s10">break</span><span class="s1">;</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s10">case</span><span class="s5"> </span><span class="s1">'discussionQuestions'</span><span class="s5">: prompt += </span><span class="s1">'請根據內容生成3到5個延伸討論問題。'</span><span class="s5">; </span><span class="s10">break</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">default</span><span class="s1">: showMessage(</span><span class="s7">'請選擇有效的資料類型。'</span><span class="s1">); loading = </span><span class="s10">false</span><span class="s1">; renderApp(); </span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> chatHistory = [{ role: </span><span class="s7">"user"</span><span class="s1">, parts: [{ text: prompt }] }];</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> payload = { contents: chatHistory, generationConfig: { responseMimeType: responseMimeType, ...(responseSchema &amp;&amp; { responseSchema: responseSchema }) } };</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> apiKey = </span><span class="s7">""</span><span class="s1">;</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s5"> apiUrl = </span><span class="s1">`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=</span><span class="s5">${apiKey}</span><span class="s1">`</span><span class="s5">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> response = </span><span class="s10">await</span><span class="s1"> fetch(apiUrl, { method: </span><span class="s7">'POST'</span><span class="s1">, headers: { </span><span class="s7">'Content-Type'</span><span class="s1">: </span><span class="s7">'application/json'</span><span class="s1"> }, body: </span><span class="s12">JSON</span><span class="s1">.stringify(payload) });</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> result = </span><span class="s10">await</span><span class="s1"> response.json();</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (result.candidates &amp;&amp; result.candidates.length &gt; </span><span class="s13">0</span><span class="s1"> &amp;&amp; result.candidates[</span><span class="s13">0</span><span class="s1">].content &amp;&amp; result.candidates[</span><span class="s13">0</span><span class="s1">].content.parts &amp;&amp; result.candidates[</span><span class="s13">0</span><span class="s1">].content.parts.length &gt; </span><span class="s13">0</span><span class="s1">) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">let</span><span class="s1"> generatedText = result.candidates[</span><span class="s13">0</span><span class="s1">].content.parts[</span><span class="s13">0</span><span class="s1">].text;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">let</span><span class="s1"> parsedContent = generatedText;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">if</span><span class="s1"> (responseMimeType === </span><span class="s7">"application/json"</span><span class="s1">) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s10">try</span><span class="s1"> { parsedContent = </span><span class="s12">JSON</span><span class="s1">.parse(generatedText); } </span><span class="s10">catch</span><span class="s1"> (jsonError) { console.error(</span><span class="s7">"Failed to parse JSON:"</span><span class="s1">, jsonError); showMessage(</span><span class="s7">`生成內容格式錯誤，請重試。`</span><span class="s1">); loading = </span><span class="s10">false</span><span class="s1">; renderApp(); </span><span class="s10">return</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">                    </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>generatedContent = {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>id: contentId, type: contentType, data: parsedContent, originalInput: inputText,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>grade: selectedGrade, subject: selectedSubject, difficulty: selectedDifficulty,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                        </span>generatedAt: </span><span class="s10">new</span><span class="s1"> </span><span class="s12">Date</span><span class="s1">().toISOString(), generatedBy: userId</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>};</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">                    </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">const</span><span class="s1"> { doc, setDoc } = window.</span><span class="s12">Firebase</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">const</span><span class="s1"> docRef = doc(db, collectionPath, contentId);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">await</span><span class="s1"> setDoc(docRef, generatedContent);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>showMessage(</span><span class="s7">'內容已成功生成並儲存！'</span><span class="s1">);</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">const</span><span class="s1"> shareableUrl = </span><span class="s7">`</span><span class="s1">${getArtifactBaseUrl()}</span><span class="s7">?student=true&amp;contentId=</span><span class="s1">${contentId}</span><span class="s7">`</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>qrCodeData = shareableUrl;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>qrCodeTitle = </span><span class="s7">`分享此</span><span class="s1">${selectedFeature === </span><span class="s7">'flashcards'</span><span class="s1"> ? </span><span class="s7">'字卡'</span><span class="s1"> : selectedFeature.startsWith(</span><span class="s7">'quiz'</span><span class="s1">) ? </span><span class="s7">'測驗'</span><span class="s1"> : </span><span class="s7">'內容'</span><span class="s1">}</span><span class="s7">給學生`</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>showQrCodeModal = </span><span class="s10">true</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>} </span><span class="s10">else</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>showMessage(</span><span class="s7">'未能生成內容，請重試。'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>console.error(</span><span class="s7">"Unexpected API response structure:"</span><span class="s1">, result);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>} </span><span class="s10">catch</span><span class="s1"> (error) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>console.error(</span><span class="s7">"生成內容時發生錯誤:"</span><span class="s1">, error);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>showMessage(</span><span class="s7">`生成內容時發生錯誤: </span><span class="s1">${error.message}</span><span class="s7">`</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>} </span><span class="s10">finally</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>loading = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>renderApp();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> renderQrCodeModal = () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> qrCodeModalHtml = </span><span class="s7">`</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;div class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50" id="qr-code-modal"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full text-center"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;h2 class="text-2xl font-bold text-gray-800 mb-4"&gt;</span><span class="s5">${qrCodeTitle}</span><span class="s1">&lt;/h2&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;div class="mb-6"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s5">${</span><span class="s12">QrCodeCanvas</span><span class="s5">(qrCodeData, </span><span class="s13">256</span><span class="s5">)}</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;p class="text-gray-700 text-sm mb-4 break-all"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>分享此連結給學生: &lt;a href="</span><span class="s5">${qrCodeData}</span><span class="s1">" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline"&gt;</span><span class="s5">${qrCodeData}</span><span class="s1">&lt;/a&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;br/&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;span class="text-red-600 font-bold mt-2 block"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                                </span>重要提示: 如果此連結無法運作，請從瀏覽器地址欄複製根 URL，並將 "?student=true&amp;contentId=</span><span class="s5">${generatedContent.id}</span><span class="s1">" 手動附加到該根 URL 後面。</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>&lt;/span&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/p&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;button onclick="copyToClipboard('</span><span class="s5">${qrCodeData}</span><span class="s1">')" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-300 mb-4"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>複製連結</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;button onclick="document.getElementById('qr-code-modal').remove();" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-300 ml-2"&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                            </span>關閉</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</span></p>
<p class="p10"><span class="s1"><span class="Apple-converted-space">            </span>`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>document.body.insertAdjacentHTML(</span><span class="s7">'beforeend'</span><span class="s1">, qrCodeModalHtml);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> copyToClipboard = (text) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> tempInput = document.createElement(</span><span class="s7">'textarea'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>tempInput.value = text;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>document.body.appendChild(tempInput);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>tempInput.select();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>document.execCommand(</span><span class="s7">'copy'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>document.body.removeChild(tempInput);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>showMessage(</span><span class="s7">'連結已複製到剪貼簿！'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">const</span><span class="s1"> renderApp = () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> root = document.getElementById(</span><span class="s7">'app-root'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (!root) </span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> params = </span><span class="s10">new</span><span class="s1"> </span><span class="s12">URLSearchParams</span><span class="s1">(window.location.search);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> isStudentView = params.</span><span class="s10">get</span><span class="s1">(</span><span class="s7">'student'</span><span class="s1">) === </span><span class="s7">'true'</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> contentId = params.</span><span class="s10">get</span><span class="s1">(</span><span class="s7">'contentId'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> studentName = params.</span><span class="s10">get</span><span class="s1">(</span><span class="s7">'studentName'</span><span class="s1">);</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (isStudentView &amp;&amp; contentId) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">const</span><span class="s1"> { html, setup } = renderStudentApp(contentId, studentName);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>root.innerHTML = html;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>setup();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>} </span><span class="s10">else</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>root.innerHTML = renderTeacherApp();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>setupTeacherEvents();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (showQrCodeModal) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>renderQrCodeModal();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// Initialize Firebase and then render the app</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>window.onload = </span><span class="s10">async</span><span class="s1"> () =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">await</span><span class="s1"> initializeFirebase();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>renderApp();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s11"></span><br></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s1">script</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s3">&lt;/</span><span class="s1">body</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s3">&lt;/</span><span class="s1">html</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s11"></span><br></p>
</body>
</html>
